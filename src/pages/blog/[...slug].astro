---
import { type CollectionEntry, getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import Note from '../../components/Note.astro';
import { Image } from 'astro:assets';

export async function getStaticPaths() {
	const posts = await getCollection('blog');
	return posts.map((post) => ({
		params: { slug: post.slug },
		props: post,
	}));
}
type Props = CollectionEntry<'blog'>;

const post = Astro.props;
const { Content, headings } = await post.render();
---

<Layout title={post.data.title} description={post.data.description} wide={true}>
	<div class="grid grid-cols-1 lg:grid-cols-12 gap-8 relative overflow-visible">
		<aside class="hidden lg:block lg:col-span-3 xl:col-span-2 order-1">
			<div class="sticky top-24">
				<TableOfContents headings={headings} />
			</div>
		</aside>
		<article class="lg:col-span-9 xl:col-span-7 order-2 prose prose-lg dark:prose-invert max-w-none prose-headings:font-bold prose-a:text-primary-600 dark:prose-a:text-primary-400 hover:prose-a:text-primary-500 prose-img:rounded-xl prose-pre:bg-gray-900 prose-pre:border prose-pre:border-gray-700 relative overflow-visible">
		<div class="mb-8 text-center not-prose">
            <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight mb-4">{post.data.title}</h1>
            <div class="text-gray-500 dark:text-gray-400 font-mono text-sm">
                <time datetime={post.data.pubDate.toISOString()}>
                    {post.data.pubDate.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                    })}
                </time>
            </div>
        </div>
        
        {post.data.heroImage && <Image src={post.data.heroImage} alt={post.data.title} width={1020} height={510} class="w-full h-auto rounded-xl shadow-md mb-8" />}
        
		<Content components={{ Note }} />
		</article>
	</div>
</Layout>

<style is:global>
	.code-block-wrapper {
		position: relative;
	}
	.copy-btn {
		position: absolute;
		top: 0.5rem;
		right: 0.5rem;
		padding: 0.25rem;
		border-radius: 0.375rem;
		border: 1px solid rgba(255, 255, 255, 0.15);
		background: rgba(255, 255, 255, 0.08);
		color: rgba(255, 255, 255, 0.5);
		cursor: pointer;
		opacity: 0;
		transition: opacity 0.15s, background 0.15s, color 0.15s;
		line-height: 1;
		z-index: 1;
	}
	.code-block-wrapper:hover .copy-btn {
		opacity: 1;
	}
	.copy-btn:hover {
		background: rgba(255, 255, 255, 0.15);
		color: rgba(255, 255, 255, 0.85);
	}
</style>

<script>
	const copyIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>`;
	const checkIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>`;

	document.querySelectorAll('article pre').forEach((pre) => {
		const wrapper = document.createElement('div');
		wrapper.className = 'code-block-wrapper';
		pre.parentNode!.insertBefore(wrapper, pre);
		wrapper.appendChild(pre);

		const btn = document.createElement('button');
		btn.className = 'copy-btn';
		btn.setAttribute('aria-label', '复制代码');
		btn.innerHTML = copyIcon;
		btn.addEventListener('click', async () => {
			const code = pre.querySelector('code');
			const text = (code || pre).textContent || '';
			await navigator.clipboard.writeText(text);
			btn.innerHTML = checkIcon;
			btn.style.color = '#4ade80';
			setTimeout(() => {
				btn.innerHTML = copyIcon;
				btn.style.color = '';
			}, 1500);
		});
		wrapper.appendChild(btn);
	});
</script>
